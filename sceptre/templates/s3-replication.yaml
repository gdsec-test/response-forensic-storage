AWSTemplateFormatVersion: 2010-09-09
Description: Bucket used for replication of objects from s3.yaml bucket

Parameters:
  ServiceCatalogVersion:
    Type: String
    Description: Service Catalog version for S3
  BucketNameSuffix:
    Type: String
    MinLength: 1
    Default: bucket1
    AllowedPattern: "[a-z][a-z0-9-]+[a-z0-9]"
    Description: Unique naming suffix for bucket
  BucketPolicy:
    Type: String
    Description: Bucket ACL to set
    Default: Private
    AllowedValues:
      - Private
      - LogDeliveryWrite
      - AwsExecRead
      - BucketOwnerRead
      - BucketOwnerFullControl
      - PublicRead
      - AuthenticatedRead
  BucketOwnerPreferred:
    Type: String
    Description: Set to true to enable ownership controls with object ownership set to BucketOwnerPreferred. Otherwise the bucket will not have ownership controls so object ownership will default to ObjectWriter.
    Default: false
    AllowedValues:
      - true
      - false
  VersioningStatus:
    Type: String
    Description: Versioning should be enabled unless there is good reason not to.
    Default: Enabled
    AllowedValues:
      - Enabled
      - Suspended
      - Disabled
  MoveToStandardIAStorageDays:
    Type: Number
    Description: (Optional) Days before moving objects to standard Infrequent Access storage. Set to -1 to never move. Defaults to never moving. Ignored if `CustomS3Bucket` is specified.
    Default: -1
  ExpirationDays:
    Type: Number
    Description: (optional) Days before expiring object. Set to -1 to never expire.
    Default: -1
  OldVersionExpirationDays:
    Type: Number
    Description: (optional) Days before expiring outdated object versions. Set to -1 to never expire.
    Default: 180
  EnableBucketMetrics:
    Type: String
    Description: Enable all available bucket metrics.
    Default: false
    AllowedValues:
      - true
      - false
  DevelopmentTeam:
    Type: AWS::SSM::Parameter::Value<String>
    Description: SSM Parameter for team owning the created resources.
    Default: /AdminParams/Team/Name
    AllowedValues:
      - /AdminParams/Team/Name
  DevelopmentEnvironment:
    Type: AWS::SSM::Parameter::Value<String>
    Description: SSM Parameter for development environment this will live in.
    Default: /AdminParams/Team/Environment
    AllowedValues:
      - /AdminParams/Team/Environment
  OrgType:
    Type: AWS::SSM::Parameter::Value<String>
    Description: Business Unit of the Account.
    Default: /AdminParams/Team/OrgType
    AllowedValues:
      - /AdminParams/Team/OrgType
  EnvMode:
    Type: AWS::SSM::Parameter::Value<String>
    Description: SSM Parameter for development mode of the account.
    Default: /AdminParams/Team/EnvMode
    AllowedValues:
      - /AdminParams/Team/EnvMode
  AccessLogsBucket:
    Type: AWS::SSM::Parameter::Value<String>
    Description: Access logs S3 bucket.
    Default: /AdminParams/BaselineBucketNames/LOBAccessLogsBucket
    AllowedValues:
      - /AdminParams/BaselineBucketNames/LOBAccessLogsBucket

Resources:
  ReplicationS3Bucket:
    Type: AWS::ServiceCatalog::CloudFormationProvisionedProduct
    Properties:
      ProductName: S3
      ProvisioningArtifactName: !Ref ServiceCatalogVersion
      ProvisionedProductName: replication-response-storage-bucket
      ProvisioningParameters:
        - Key: BucketNameSuffix
          Value: !Ref BucketNameSuffix
        - Key: BucketPolicy
          Value: !Ref BucketPolicy
        - Key: VersioningStatus
          Value: !Ref VersioningStatus
        - Key: ExpirationDays
          Value: !Ref ExpirationDays
        - Key: OldVersionExpirationDays
          Value: !Ref OldVersionExpirationDays
        - Key: EnableBucketMetrics
          Value: !Ref EnableBucketMetrics
        - Key: BucketOwnerPreferred
          Value: !Ref BucketOwnerPreferred
        - Key: MoveToStandardIAStorageDays
          Value: !Ref MoveToStandardIAStorageDays
        - Key: CustomBucketPolicyJSON
          Value: !Sub |
            {
              "Version": "2012-10-17",
              "Statement": [
                  {
                      "Effect": "Allow",
                      "Principal": {
                          "AWS": "arn:aws:iam::763338924548:root"
                      },
                      "Action": "s3:*",
                      "Resource": [
                          "arn:aws:s3:::gd-${DevelopmentTeam}-${DevelopmentEnvironment}-${BucketNameSuffix}",
                          "arn:aws:s3:::gd-${DevelopmentTeam}-${DevelopmentEnvironment}-${BucketNameSuffix}/*"
                      ]
                  },
                  {
                      "Effect": "Allow",
                      "Principal": {
                          "AWS": "*"
                      },
                      "Action": [
                          "s3:Get*",
                          "s3:List*"
                      ],
                      "Resource": [
                          "arn:aws:s3:::gd-${DevelopmentTeam}-${DevelopmentEnvironment}-${BucketNameSuffix}",
                          "arn:aws:s3:::gd-${DevelopmentTeam}-${DevelopmentEnvironment}-${BucketNameSuffix}/*"
                      ],
                      "Condition": {
                          "StringEquals": {
                              "aws:PrincipalOrgID": "o-nkgi7akmvi"
                          },
                          "ArnEquals": {
                              "aws:PrincipalArn": [
                                  "arn:aws:iam::197818030129:role/respforens-custom-iam-ec2-role"                    ]
                          }
                      }
                  },
              {
                      "Effect": "Deny",
                      "Principal": {
                          "AWS": "*"
                      },
                      "Action": [
                          "s3:Delete*"
                      ],
                      "Resource": [
                          "arn:aws:s3:::gd-${DevelopmentTeam}-${DevelopmentEnvironment}-${BucketNameSuffix}",
                          "arn:aws:s3:::gd-${DevelopmentTeam}-${DevelopmentEnvironment}-${BucketNameSuffix}/*"
                      ],
                      "Condition": {
                          "StringEquals": {
                              "aws:PrincipalOrgID": "o-nkgi7akmvi"
                          },
                          "ArnEquals": {
                              "aws:PrincipalArn": [
                                  "arn:aws:iam::763338924548:role/GD-AWS-USA-GD-RespStorag-Ops"
                              ]
                          }
                      }
                  }
              ]
            }

      Tags:
        - Key: doNotShutDown
          Value: true

Outputs:
  BucketName:
    Description: "Name of created S3 Bucket"
    Value: !Ref ReplicationS3Bucket
